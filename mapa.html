<!-- Leaflet CSS -->  
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />  
  
<!-- Leaflet JS -->  
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  
  
<!-- Firebase SDK (versi√≥n compat para compatibilidad con navegadores) -->  
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>  
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>  
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>  
  
<!-- geofire-common para c√°lculo de geohash -->  
<script src="https://cdn.jsdelivr.net/npm/geofire-common@6.0.0/dist/geofire-common.min.js"></script>  
  
<style>  
  /* Tema oscuro personalizado Dirty Roots */  
  .leaflet-container {  
    background: var(--color-grey-4, #0B0B0B);  
  }  
    
  .leaflet-tile {  
    filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);  
  }  
    
  .leaflet-popup-content-wrapper {  
    background: var(--color-grey-7, #111111);  
    color: var(--color-grey-96, #F5F5F5);  
    border-radius: 12px;  
    border: 1px solid rgba(164, 203, 62, 0.20);  
  }  
    
  .leaflet-popup-tip {  
    background: var(--color-grey-7, #111111);  
  }  
    
  .custom-marker {  
    font-size: 24px;  
    text-align: center;  
  }  
    
  /* Scrollbar personalizado para lista de lugares */  
  .places-list::-webkit-scrollbar {  
    width: 8px;  
  }  
    
  .places-list::-webkit-scrollbar-track {  
    background: #0F0F0F;  
    border-radius: 4px;  
  }  
    
  .places-list::-webkit-scrollbar-thumb {  
    background: #2A2A2A;  
    border-radius: 4px;  
  }  
    
  .places-list::-webkit-scrollbar-thumb:hover {  
    background: #A4CB3E;  
  }  
</style>  
  
<script>  
// Esperar a que el DOM est√© completamente cargado  
document.addEventListener('DOMContentLoaded', function() {  
  (function(){  
    // Verificar que Firebase est√© disponible  
    if (typeof firebase === 'undefined') {  
      console.error('Firebase SDK no cargado');  
      const container = document.getElementById('places-list-container');  
      if (container) {  
        container.innerHTML = `  
          <div style="text-align: center; padding: 40px; color: #FF60A8;">  
            <p>Error: Firebase SDK no disponible. Por favor, recarga la p√°gina.</p>  
          </div>  
        `;  
      }  
      return;  
    }  

    console.log('‚úÖ Firebase SDK cargado correctamente');  
    
    // Verificar geofire-common  
    if (typeof geofire === 'undefined') {  
        console.warn('‚ö†Ô∏è geofire-common no disponible');  
    } else {  
        console.log('‚úÖ geofire-common cargado correctamente');  
    }  
        
    // Verificar Leaflet  
    if (typeof L === 'undefined') {  
        console.error('‚ùå Leaflet no cargado');  
        return;  
    }  
        
    console.log('‚úÖ Leaflet cargado correctamente');  
  
    // Configuraci√≥n de Firebase  
    const firebaseConfig = {  
      apiKey: "AIzaSyDi-cNvkgCvf8bVl9M_umjH8KaDnOqJDO0",  
      authDomain: "dirty-roots-1270f.firebaseapp.com",  
      projectId: "dirty-roots-1270f",  
      storageBucket: "dirty-roots-1270f.firebasestorage.app",  
      messagingSenderId: "44442627071",  
      appId: "1:44442627071:web:58a1cbf3f485fe1fa0d5ca",  
      measurementId: "G-5DR9Y1V3HP"  
    };  
      
    // Inicializar Firebase con manejo de errores  
    try {  
      firebase.initializeApp(firebaseConfig);  
      console.log('Firebase inicializado correctamente');  
    } catch (error) {  
      console.error('Error inicializando Firebase:', error);  
      showError('Error de configuraci√≥n de Firebase');  
      return;  
    }  
      
    const db = firebase.firestore();  
    const auth = firebase.auth();  
      
    let stillnessSpots = [];  
    let map = null;  
    let markers = [];  
      
    // Funci√≥n para mostrar errores  
    function showError(message) {  
      const container = document.getElementById('places-list-container');  
      if (container) {  
        container.innerHTML = `  
          <div style="text-align: center; padding: 40px; color: #FF60A8;">  
            <div style="font-size: 32px; margin-bottom: 16px;">‚ö†Ô∏è</div>  
            <p>${message}</p>  
            <button onclick="location.reload()" style="margin-top: 16px; padding: 10px 20px; background: #A4CB3E; border: none; border-radius: 999px; color: #0B0B0B; font-weight: bold; cursor: pointer;">  
              Recargar p√°gina  
            </button>  
          </div>  
        `;  
      }  
    }  
      
    // Funci√≥n para calcular geohash con fallback  
    function calculateGeohash(lat, lng) {  
      if (typeof geofire !== 'undefined' && geofire.geohashForLocation) {  
        return geofire.geohashForLocation([lat, lng]);  
      }  
      console.warn('geofire-common no disponible, usando geohash b√°sico');  
      // Fallback simple: concatenar coordenadas redondeadas  
      return `${lat.toFixed(3)}${lng.toFixed(3)}`.replace(/\./g, '').substring(0, 7);  
    }  
      
    // Cargar lugares desde Firestore  
    async function loadPlaces() {  
      try {  
        console.log('Cargando lugares desde Firestore...');  
          
        const snapshot = await db.collection('places')  
          .where('status', '==', 'approved')  
          .orderBy('createdAt', 'desc')  
          .limit(100)  
          .get();  
          
        console.log(`Lugares encontrados: ${snapshot.size}`);  
          
        stillnessSpots = snapshot.docs.map(doc => {  
          const data = doc.data();  
          return {  
            id: doc.id,  
            name: data.name || 'Sin nombre',  
            description: data.description || '',  
            lat: data.coords?.lat || 0,  
            lng: data.coords?.lng || 0,  
            photo: data.photo || null,  
            city: data.city || '',  
            tags: data.tags || [],  
            noiseLevel: data.noiseLevel  
          };  
        });  
          
        if (stillnessSpots.length === 0) {  
          console.warn('No se encontraron lugares aprobados');  
        }  
          
        renderMap();  
        renderList();  
      } catch (error) {  
        console.error('Error cargando lugares:', error);  
        console.error('Detalles del error:', error.code, error.message);  
        showError(`Error al cargar lugares: ${error.message}`);  
      }  
    }  
      
    // Renderizar mapa  
    function renderMap() {  
      const mapContainer = document.getElementById('stillness-map');  
      if (!mapContainer) {  
        console.error('Contenedor del mapa no encontrado');  
        return;  
      }  
  
      if (!map) {  
        map = L.map('stillness-map', {  
          center: [50.0, 10.0],  
          zoom: 5,  
          zoomControl: true,  
          scrollWheelZoom: false  
        });  
          
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {  
          attribution: '',  
          maxZoom: 18  
        }).addTo(map);  
      }  
        
      // Limpiar marcadores existentes  
      markers.forEach(marker => map.removeLayer(marker));  
      markers = [];  
        
      // A√±adir marcadores  
      stillnessSpots.forEach(spot => {  
        const icon = L.divIcon({  
          html: '<div class="custom-marker">üåø</div>',  
          className: 'custom-leaflet-marker',  
          iconSize: [30, 30],  
          iconAnchor: [15, 30]  
        });  
          
        const marker = L.marker([spot.lat, spot.lng], { icon }).addTo(map);  
        markers.push(marker);  
          
        const popupContent = `  
          <div style="padding: 12px; min-width: 200px;">  
            <h3 style="margin: 0 0 8px 0; color: var(--color-chartreuse-green-52, #A4CB3E); font-size: 16px; font-weight: 700;">  
              ${spot.name}  
            </h3>  
            ${spot.city ? `<p style="margin: 0 0 8px 0; color: var(--color-grey-73, #B6B9BF); font-size: 12px;">üìç ${spot.city}</p>` : ''}  
            <p style="margin: 0 0 12px 0; color: var(--color-grey-73, #B6B9BF); font-size: 14px; line-height: 1.5;">  
              ${spot.description}  
            </p>  
            ${spot.photo ? `<img src="${spot.photo}" style="width: 100%; border-radius: 8px; margin-bottom: 12px;" />` : ''}  
            ${spot.tags && spot.tags.length > 0 ? `<p style="margin: 0 0 8px 0; color: var(--color-grey-73, #B6B9BF); font-size: 12px;">#${spot.tags.join(' #')}</p>` : ''}  
            ${spot.noiseLevel !== undefined ? `<p style="margin: 0 0 12px 0; color: var(--color-grey-73, #B6B9BF); font-size: 12px;">üîä Nivel de ruido: ${spot.noiseLevel}/5</p>` : ''}  
            <a href="https://www.google.com/maps?q=${spot.lat},${spot.lng}"   
               target="_blank"   
               style="color: var(--color-chartreuse-green-52, #A4CB3E); text-decoration: none; font-size: 13px;">  
              üìç View on Google Maps  
            </a>  
          </div>  
        `;  
          
        marker.bindPopup(popupContent, {  
          maxWidth: 300,  
          className: 'stillness-popup'  
        });  
          
        marker.on('click', () => {  
          updateSpotList(spot);  
        });  
      });  
    }  
      
    // Renderizar lista lateral  
    function renderList() {  
      const container = document.getElementById('places-list-container');  
      if (!container) {  
        console.error('Contenedor de lista no encontrado');  
        return;  
      }  
        
      if (stillnessSpots.length === 0) {  
        container.innerHTML = `  
          <div style="text-align: center; padding: 40px; color: var(--color-grey-73, #B6B9BF);">  
            <div style="font-size: 32px; margin-bottom: 16px;">üåø</div>  
            <p>No hay lugares todav√≠a. ¬°S√© el primero en a√±adir uno!</p>  
          </div>  
        `;  
        return;  
      }  
        
      const listHTML = stillnessSpots.slice(0, 10).map(spot => `  
        <div class="place-card" data-spot-id="${spot.id}" style="align-self: stretch; padding: 12px 13px; background: var(--color-grey-6, #0F0F0F); border-radius: 14px; outline: 1px var(--color-grey-14, #242424) solid; outline-offset: -1px; flex-direction: column; justify-content: flex-start; align-items: flex-start; display: flex; cursor: pointer; transition: all 0.2s;">  
          <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%; margin-bottom: 4px;">  
            <div style="justify-content: center; display: flex; flex-direction: column; color: var(--color-grey-96, #F5F5F5); font-size: 16px; font-family: Segoe UI; font-weight: 700; line-height: 23.20px; word-wrap: break-word; flex: 1;">  
              ${spot.name}  
            </div>  
            ${spot.city ? `<span style="font-size: 12px; color: var(--color-grey-73, #B6B9BF); background: var(--color-grey-7, #111111); padding: 4px 8px; border-radius: 999px; margin-left: 8px;">üìç ${spot.city}</span>` : ''}  
          </div>  
          <div style="justify-content: center; display: flex; flex-direction: column; color: var(--color-grey-73, #B6B9BF); font-size: 14.60px; font-family: Segoe UI; font-weight: 400; line-height: 21.34px; word-wrap: break-word;">  
            ${spot.description}  
          </div>  
          ${spot.tags && spot.tags.length > 0 ? `  
            <div style="margin-top: 8px; font-size: 12px; color: var(--color-grey-73, #B6B9BF);">  
              #${spot.tags.join(' #')}  
            </div>  
          ` : ''}  
          ${spot.noiseLevel !== undefined ? `  
            <div style="margin-top: 8px; font-size: 12px; color: var(--color-grey-73, #B6B9BF);">  
              üîä ${spot.noiseLevel}/5  
            </div>  
          ` : ''}  
        </div>  
      `).join('');  
        
      container.innerHTML = listHTML;  

       // A√±adir event listeners para hacer clic en las tarjetas  
      document.querySelectorAll('.place-card').forEach((card, index) => {  
        card.addEventListener('click', () => {  
          const spot = stillnessSpots[index];  
          if (map) {  
            map.flyTo([spot.lat, spot.lng], 15, { duration: 1.5 });  
          }  
          updateSpotList(spot);  
        });  
          
        card.addEventListener('mouseenter', () => {  
          card.style.background = 'var(--color-grey-7, #111111)';  
          card.style.outline = '1px solid rgba(164, 203, 62, 0.3)';  
        });  
          
        card.addEventListener('mouseleave', () => { 
             card.style.background = 'var(--color-grey-6, #0F0F0F)';  
        card.style.outline = '1px var(--color-grey-14, #242424) solid';  
      });  
    });  
  }  
    
  // Funci√≥n para actualizar la lista lateral al hacer clic en marcador  
  function updateSpotList(selectedSpot) {  
    const spotCards = document.querySelectorAll('.place-card');  
    spotCards.forEach((card) => {  
      const spotId = card.getAttribute('data-spot-id');  
      if (spotId === selectedSpot.id) {  
        card.style.outline = '2px solid var(--color-chartreuse-green-52, #A4CB3E)';  
        card.style.outlineOffset = '2px';  
      } else {  
        card.style.outline = '1px var(--color-grey-14, #242424) solid';  
        card.style.outlineOffset = '-1px';  
      }  
    });  
  }  
    
  // Inicializar la aplicaci√≥n  
  loadPlaces();  
    
  // Bot√≥n "Submit a spot" - Modal con integraci√≥n Firebase  
  const submitBtn = document.querySelector('[data-layer="Submit a spot"]').closest('.Link');  
  if (submitBtn) {  
    submitBtn.addEventListener('click', (e) => {  
      e.preventDefault();  
        
      const formHTML = `  
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="submit-spot-modal">  
          <div style="background: var(--color-grey-7, #111111); padding: 32px; border-radius: 20px; max-width: 500px; width: 90%; border: 1px solid rgba(164, 203, 62, 0.20);">  
            <h2 style="color: var(--color-chartreuse-green-52, #A4CB3E); margin: 0 0 24px 0;">Submit Your Stillness Spot</h2>  
              
            <input type="text" id="spot-name" placeholder="Spot name" style="width: 100%; padding: 12px; margin-bottom: 16px; background: var(--color-grey-4, #0B0B0B); border: 1px solid var(--color-grey-16, #2A2A2A); border-radius: 8px; color: var(--color-grey-96, #F5F5F5); font-family: Segoe UI;" />  
              
            <input type="text" id="spot-city" placeholder="City" style="width: 100%; padding: 12px; margin-bottom: 16px; background: var(--color-grey-4, #0B0B0B); border: 1px solid var(--color-grey-16, #2A2A2A); border-radius: 8px; color: var(--color-grey-96, #F5F5F5); font-family: Segoe UI;" />  
              
            <textarea id="spot-description" placeholder="Poetic description..." rows="3" style="width: 100%; padding: 12px; margin-bottom: 16px; background: var(--color-grey-4, #0B0B0B); border: 1px solid var(--color-grey-16, #2A2A2A); border-radius: 8px; color: var(--color-grey-96, #F5F5F5); font-family: Segoe UI; resize: vertical;"></textarea>  
              
            <input type="text" id="spot-coords" placeholder="Coordinates (lat, lng)" style="width: 100%; padding: 12px; margin-bottom: 16px; background: var(--color-grey-4, #0B0B0B); border: 1px solid var(--color-grey-16, #2A2A2A); border-radius: 8px; color: var(--color-grey-96, #F5F5F5); font-family: Segoe UI;" />  
              
            <input type="text" id="spot-tags" placeholder="Tags (comma separated)" style="width: 100%; padding: 12px; margin-bottom: 16px; background: var(--color-grey-4, #0B0B0B); border: 1px solid var(--color-grey-16, #2A2A2A); border-radius: 8px; color: var(--color-grey-96, #F5F5F5); font-family: Segoe UI;" />  
              
            <input type="number" id="spot-noise" placeholder="Noise level (0-5)" min="0" max="5" style="width: 100%; padding: 12px; margin-bottom: 24px; background: var(--color-grey-4, #0B0B0B); border: 1px solid var(--color-grey-16, #2A2A2A); border-radius: 8px; color: var(--color-grey-96, #F5F5F5); font-family: Segoe UI;" />  
              
            <div style="display: flex; gap: 12px;">  
              <button id="submit-spot-btn" style="flex: 1; padding: 14px; background: var(--color-chartreuse-green-52, #A4CB3E); border: none; border-radius: 999px; color: var(--color-grey-4, #0B0B0B); font-weight: 700; cursor: pointer;">Submit</button>  
              <button id="cancel-spot-btn" style="flex: 1; padding: 14px; background: transparent; border: 1px solid var(--color-rose-69, #FF60A8); border-radius: 999px; color: var(--color-grey-96, #F5F5F5); font-weight: 700; cursor: pointer;">Cancel</button>  
            </div>  
          </div>  
        </div>  
      `;  
        
      document.body.insertAdjacentHTML('beforeend', formHTML);  
        
      document.getElementById('cancel-spot-btn').addEventListener('click', () => {  
        document.getElementById('submit-spot-modal').remove();  
      });  
        
      document.getElementById('submit-spot-btn').addEventListener('click', async () => {  
        const spotData = {  
          name: document.getElementById('spot-name').value,  
          city: document.getElementById('spot-city').value,  
          description: document.getElementById('spot-description').value,  
          coords: document.getElementById('spot-coords').value,  
          tags: document.getElementById('spot-tags').value,  
          noiseLevel: document.getElementById('spot-noise').value  
        };  
          
        // Validar campos requeridos  
        if (!spotData.name || !spotData.coords) {  
          alert('Please fill in name and coordinates');  
          return;  
        }  
          
        // Parsear coordenadas (formato: "lat, lng")  
        const coordsParts = spotData.coords.split(',').map(s => s.trim());  
        if (coordsParts.length !== 2) {  
          alert('Invalid coordinates format. Use: lat, lng');  
          return;  
        }  
          
        const lat = parseFloat(coordsParts[0]);  
        const lng = parseFloat(coordsParts[1]);  
          
        if (isNaN(lat) || isNaN(lng)) {  
          alert('Invalid coordinates. Please enter valid numbers.');  
          return;  
        }  
          
        // Validar rangos de coordenadas  
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {  
          alert('Coordinates out of range. Latitude: -90 to 90, Longitude: -180 to 180');  
          return;  
        }  
          
        try {  
          // Calcular geohash  
          const geohash = calculateGeohash(lat, lng);  
            
          // Parsear tags  
          const tagsArray = spotData.tags   
            ? spotData.tags.split(',').map(t => t.trim()).filter(Boolean)   
            : [];  
            
          // Parsear nivel de ruido  
          const noiseLevel = spotData.noiseLevel ? parseInt(spotData.noiseLevel) : 0;  
            
          // Guardar en Firestore  
          await db.collection('places').add({  
            name: spotData.name,  
            city: spotData.city || '',  
            description: spotData.description || '',  
            coords: { lat, lng },  
            geohash: geohash,  
            tags: tagsArray,  
            noiseLevel: noiseLevel,  
            photo: null,  
            createdBy: auth.currentUser?.uid || 'anonymous',  
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),  
            status: 'pending' // Requiere aprobaci√≥n manual  
          });  
            
          alert('Thank you! Your spot will be reviewed by the team.');  
          document.getElementById('submit-spot-modal').remove();  
            
          // Recargar lugares para mostrar el nuevo (si est√° aprobado)  
          loadPlaces();  
        } catch (error) {  
          console.error('Error submitting spot:', error);  
          alert('Error submitting spot. Please try again.');  
        }  
      });  
    });  
  }  
})();  
</script>